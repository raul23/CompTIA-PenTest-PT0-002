====================================
Lab Exercises: Information gathering
====================================

.. contents:: **Contents**
   :depth: 5
   :local:
   :backlinks: top

Book: CompTIA Pentest+ Certification For Dummies (2nd ed., 2022)
================================================================
`:information_source:` These lab exercises and prep test are from the book:

   Clarke, Glen E. `CompTIA Pentest+ Certification For Dummies`_. 2nd ed., 2022.

.. URLs books
.. _CompTIA Pentest+ Certification For Dummies: https://www.amazon.com/CompTIA-Pentest-Certification-Dummies-Computer/dp/1119867274

Lab Exercises
-------------
Exercise 3-1: Conduct a Whois Search with ARIN
""""""""""""""""""""""""""""""""""""""""""""""
`:information_source:` using **www.arin.net/whois** to get information about an organization

1. Search for an organization
2. Click on the link for the Handle **"MICRO-218"**
3. At the bottom of the results, the entry **"Net Range"** gives the **public IPs** for the organization

   These are the public IP blocks that need to be documented in the pentest report.

Exercise 3-2: Use ``theHarvester`` to collect email addresses
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
`:information_source:` using ``theHarvester`` to collect email addresses and hosts IP addresses for an organization

On a terminal:

.. code-block::
   
   $ theharvester -d example.com -b all

The email and IP address need to be documented in the pentest report.

Exercise 3-3: Use Shodan to discover systems on the Internet
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
`:information_source:` 
 
 - Using **shodan.io** to discover systems and information about systems on the Internet for an organization
 - You need to register to use **shodan.io**
 - The "View on Map" tab is only available if you become a member 
 - Search performed on 2023-02-16

1. Search for an organization
2. When clicking on an IP address, you can get lots of info about the organization such as:

   - Country, City, Organization, ISP, ASN
   - Vulnerabilities (list of CVEs), e.g.::
   
      CVE-2021-31806	An issue was discovered in Squid before 4.15 and 5.x before 5.0.6. Due to a 
                        memory-management bug, it is vulnerable to a Denial of Service attack (against 
                        all clients using the proxy) via HTTP Range request processing.
   - Certificates: name of server that issued them and their paths
   - Open Ports
   - The output from the server when connecting to an open port, e.g.::
  
      HTTP/1.1 400 Bad Request
      Server: squid/4.14
      Mime-Version: 1.0
      Date: Thu, 16 Feb 2023 19:07:45 GMT
      Content-Type: text/html;charset=utf-8
      Content-Length: 16
      X-Squid-Error: ERR_INVALID_URL 0

     `:information_source:` **Squid** is a caching and forwarding HTTP web proxy (from 
     `en.wikipedia.org/wiki/Squid_(software) <https://en.wikipedia.org/wiki/Squid_(software)>`_).

Exercise 3-4: Use ``recon-ng`` for OSINT information gathering
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
`:warning:` Google search module ``recon/domains-hosts/google_site_web``

 Be careful when using the Google search module ``recon/domains-hosts/google_site_web`` since
 you will be sending multiple HTTP requests to Google which might flag your IP address as belonging to a bot (CAPTCHA)!

|

`:information_source:` 

 - Using ``recon-ng`` to perform OSINT information gathering
 - I used ``recon-ng`` v5.1.2 (the book uses an older version which uses a different syntax for a lot of the commands such 
   as ``workspaces add acme`` or ``add domains acme.com``)
 - Check the tutorial `101labs.net <https://www.101labs.net/comptia-security/lab-3-recon-ng/>`_ which uses ``recon-ng`` v5.1.1
 - Search performed on 2023-02-16

1. Start ``recon-ng`` and create a workspace: ``workspaces create <project_name>``
 
   .. code-block::
   
      $ recon-ng
      
      [recon-ng][default] > workspaces create acme
      [recon-ng][acme] > 
  
2. Configure the domains and the company names: ``db insert domains`` and ``db insert companies``

   .. code-block::
   
      [recon-ng][acme] > db insert domains
      domain (TEXT): acme.com
      notes (TEXT): 
      
      [recon-ng][acme] > db insert companies
      company (TEXT): Acme~A publishing company
      description (TEXT):
      notes (TEXT): 

3. To view the domains and company tables: ``show domains`` and ``show companies``

   .. code-block::
   
        [recon-ng][acme] > show domains

        +----------------------------------------------+
        | rowid |     domain    | notes |    module    |
        +----------------------------------------------+
        | 1     | acme.com      |       | user_defined |
        +----------------------------------------------+
        
        [recon-ng][acme] > show companies

        +-------------------------------------------------------------------------+
        | rowid |          company           | description | notes |    module    |
        +-------------------------------------------------------------------------+
        | 1     | Acme~A publishing company  |             |       | user_defined |
        +-------------------------------------------------------------------------+

4. Install the WHOIS search module ``whois_pocs``: ``marketplace install recon/domains-contacts/whois_pocs``

   .. code-block::
   
      [recon-ng][acme] > marketplace search whois
      [*] Searching module index for 'whois'...                                                                                            
                                                                                                                                     
        +----------------------------------------------------------------------------------------------+                                   
        |                      Path                     | Version |     Status    |  Updated   | D | K |                                   
        +----------------------------------------------------------------------------------------------+                                   
        | recon/companies-domains/viewdns_reverse_whois | 1.1     | not installed | 2021-08-24 |   |   |
        | recon/companies-multi/whois_miner             | 1.1     | not installed | 2019-10-15 |   |   |
        | recon/domains-companies/whoxy_whois           | 1.1     | not installed | 2020-06-24 |   | * |
        | recon/domains-contacts/whois_pocs             | 1.0     | not installed | 2019-06-24 |   |   |
        | recon/netblocks-companies/whois_orgs          | 1.0     | not installed | 2019-06-24 |   |   |
        +----------------------------------------------------------------------------------------------+

        D = Has dependencies. See info for details.
        K = Requires keys. See info for details.

      [recon-ng][acme] > marketplace install recon/domains-contacts/whois_pocs
      [*] Module installed: recon/domains-contacts/whois_pocs
      [*] Reloading modules...

5. Load the module ``whois_pocs``: ``modules load recon/domains-contacts/whois_pocs``

   .. code-block::
   
      [recon-ng][acme] > modules load recon/domains-contacts/whois_pocs
      [recon-ng][acme][whois_pocs] >

6. To see information about the module ``whois_pocs``: ``info``

   .. code-block::
   
      [recon-ng][acme][whois_pocs] > info

            Name: Whois POC Harvester
          Author: Tim Tomes (@lanmaster53)
         Version: 1.0

      Description:
        Uses the ARIN Whois RWS to harvest POC data from whois queries for the given domain. Updates the
        'contacts' table with the results.

      Options:
        Name    Current Value  Required  Description
        ------  -------------  --------  -----------
        SOURCE  default        yes       source of input (see 'info' for details)

      Source Options:
        default        SELECT DISTINCT domain FROM domains WHERE domain IS NOT NULL
        <string>       string representing a single input
        <path>         path to a file containing a list of inputs
        query <sql>    database query returning one column of inputs

7. Begin searching WHOIS for information regarding “acme.com”: ``run``

   .. code-block::
   
      [recon-ng][acme][whois_pocs] > run

      ---------
      ACME.COM
      ---------
      [*] URL: http://whois.arin.net/rest/pocs;domain=acme.com
      [*] URL: http://whois.arin.net/rest/poc/EMBLE-ARIN
      [*] Country: United States
      [*] Email: blabla@acme.com
      [*] First_Name: Bla
      [*] Last_Name: Blabla
      [*] Middle_Name: None
      [*] Notes: None
      [*] Phone: None
      [*] Region: Toronto, ON
      [*] Title: Whois contact
      [*] --------------------------------------------------

8. Quit out of the ``whois_pocs`` module with the ``back`` command:

   .. code-block::
   
      [recon-ng][acme][whois_pocs] > back
      [recon-ng][acme] >

9. Install the Google and Bing search modules: ``marketplace install recon/domains-hosts/google_site_web`` and 
   ``marketplace install recon/domains-hosts/bing_domain_web``

   .. code-block::
   
      [recon-ng][acme] > marketplace search google
      [*] Searching module index for 'google'...

        +------------------------------------------------------------------------------------+
        |                 Path                | Version |     Status    |  Updated   | D | K |
        +------------------------------------------------------------------------------------+
        | recon/domains-hosts/google_site_web | 1.0     | not installed | 2019-06-24 |   |   |
        +------------------------------------------------------------------------------------+

        D = Has dependencies. See info for details.
        K = Requires keys. See info for details.
        
      [recon-ng][acme] > marketplace install recon/domains-hosts/google_site_web
      [*] Module installed: recon/domains-hosts/google_site_web
      [*] Reloading modules...

      [recon-ng][acme] > marketplace search bing
      [*] Searching module index for 'bing'...

        +-----------------------------------------------------------------------------------------------+
        |                      Path                      | Version |     Status    |  Updated   | D | K |
        +-----------------------------------------------------------------------------------------------+
        | recon/companies-contacts/bing_linkedin_cache   | 1.0     | not installed | 2019-06-24 |   | * |
        | recon/domains-hosts/bing_domain_api            | 1.0     | not installed | 2019-06-24 |   | * |
        | recon/domains-hosts/bing_domain_web            | 1.1     | not installed | 2019-07-04 |   |   |
        | recon/hosts-hosts/bing_ip                      | 1.0     | not installed | 2019-06-24 |   | * |
        | recon/profiles-contacts/bing_linkedin_contacts | 1.2     | not installed | 2021-08-24 |   | * |
        +-----------------------------------------------------------------------------------------------+

        D = Has dependencies. See info for details.
        K = Requires keys. See info for details.

      [recon-ng][acme] > marketplace install recon/domains-hosts/bing_domain_web
      [*] Module installed: recon/domains-hosts/bing_domain_web
      [*] Reloading modules...

10. Load the module ``google_site_web``: ``modules load recon/domains-hosts/google_site_web``

    .. code-block::
   
       [recon-ng][acme] > modules load recon/domains-hosts/google_site_web
       [recon-ng][acme][google_site_web] >

11. Retrieve a list of related domains and hosts from Google: ``run``

    .. code-block::
   
         [recon-ng][acme][google_site_web] > run
      
         ---------
         ACME.COM
         ---------
         [*] Searching Google for: site:acme.com
         [*] Country: None
         [*] Host: analyticals.online.acme.com
         [*] Ip_Address: None
         [*] Latitude: None
         [*] Longitude: None
         [*] Notes: None
         [*] Region: None
         [*] --------------------------------------------------

         [...]

         -------------
         WWW.ACME.COM
         -------------
         [*] Searching Google for: site:www.acme.com
         [!] Google CAPTCHA triggered. No bypass available.

         [...]

         -------
         SUMMARY
         -------
         [*] 41 total (41 new) hosts found.

    `:warning:` ``[!] Google CAPTCHA triggered. No bypass available.``
    
    `:information_source:` an attacker can target the various subdomains and IP addresses associated with acme.com 
    as they may not all be equally secure (from `101labs.net/comptia-security/lab-3-recon-ng 
    <https://www.101labs.net/comptia-security/lab-3-recon-ng/>`_)

12. Quit out (``back``) from the Google search module and repeat steps 10 and 11 but with the Bing search module

    `:information_source:` 
    
     - The Bing search module sleeps to avoid lockout
    
       .. code-block::

          [*] Sleeping to avoid lockout...
          
     - There is no triggered CAPTCHA-like messages as it is the case with the Google search module

13. Install and load the module ``reporting/html``: ``marketplace install reporting/html`` and ``modules load reporting/html``

    .. code-block::
    
         [recon-ng][acme] > marketplace search reporting                                                                                             
         [*] Searching module index for 'reporting'...                                                                                                 

           +--------------------------------------------------------------------+
           |         Path        | Version |     Status    |  Updated   | D | K |
           +--------------------------------------------------------------------+
           | reporting/csv       | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/html      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/json      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/list      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/proxifier | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/pushpin   | 1.0     | not installed | 2019-06-24 |   | * |
           | reporting/xlsx      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/xml       | 1.1     | not installed | 2019-06-24 |   |   |
           +--------------------------------------------------------------------+

           D = Has dependencies. See info for details.
           K = Requires keys. See info for details.

         [recon-ng][acme] > marketplace install reporting/html
         [*] Module installed: reporting/html
         [*] Reloading modules...
         
         [recon-ng][acme] > modules load reporting/html
         [recon-ng][acme][html] > info

            Name: HTML Report Generator
          Author: Tim Tomes (@lanmaster53)
         Version: 1.0

         Description:
           Creates an HTML report.

         Options:
           Name      Current Value                                       Required  Description
           --------  -------------                                       --------  -----------
           CREATOR                                                       yes       use creator name in the report footer
           CUSTOMER                                                      yes       use customer name in the report header
           FILENAME  /home/kali/.recon-ng/workspaces/acme/results.html   yes       path and filename for report output
           SANITIZE  True                                                yes       mask sensitive data in the report

14. Generate an HTML report: ``options set CREATOR 'John Doe'`` and ``options set CUSTOMER 'Jack Adams'``

    .. code-block::
   
         [recon-ng][acme][html] > options set CREATOR 'John Doe'
         CREATOR => 'John Doe'
         [recon-ng][acme][html] > options set CUSTOMER 'Jack Adams'
         CUSTOMER => 'Jack Adams'
         [recon-ng][acme][html] > run

Exercise 3-5: Use ``dig`` for DNS profiling
"""""""""""""""""""""""""""""""""""""""""""
`:information_source:` using ``dig`` to perform DNS profiling of an organization

1. Get the IP address of a system:

   .. code-block::
   
      dig www.domain_name.com +short
      
2. Get the DNS servers for the company:
 
   .. code-block::
   
      dig domain_name.com NS +short
      
4. Get the email servers for the company:

   .. code-block::
   
      dig domain_name.com MX +short
      
Exercise 3-6: Use ``nmap`` to port scan
"""""""""""""""""""""""""""""""""""""""
`:information_source:` 

 - using ``nmap`` to perform a port scan of your network
 - I used ``nmap`` v7.92
 - Scan performed on 2023-02-16

1. Perform a SYN scan (*aka* a half-open scan) of your network (router):

   .. code-block::
   
      $ sudo nmap -sS 192.168.1.0
      Password:
      Starting Nmap 7.92 ( https://nmap.org ) at 2023-02-16 20:34 EST
      Nmap scan report for 192.168.1.0
      Host is up (0.015s latency).
      Not shown: 968 closed tcp ports (reset), 28 filtered tcp ports (no-response)
      PORT      STATE SERVICE
      80/tcp    open  http
      
   `:information_source:` If I don't use ``sudo``
   
   .. code-block::
   
      $ nmap -sS 192.168.1.0 
      You requested a scan type which requires root privileges.
      QUITTING!

2. Do a version scan of each of the open ports of your network:

   .. code-block::
   
      $ nmap -sV 192.168.1.0

3. Identify the OS that is running on the system (i.e. OS fingerprinting):

   .. code-block::
   
      $ sudo nmap -sS -O 192.168.1.0

|

`:information_source:` Find private IP addresses of your router and machine

 - Get the private IP address of your router/gateway:
 
   - On Linux: ``ip r | grep default``
      
     More Linux commands at `cyberciti.biz <https://www.cyberciti.biz/faq/how-to-find-gateway-ip-address/>`_
   
   - On `macOS <https://www.security.org/vpn/find-router-ip-address/>`_: ``netstat -nr|grep default``
      
 - Get your machine's local/private IP address:
 
   - On Linux: 
   
     - 1st method: ``ifconfig -a``
     - 2nd method: ``ip addr`` or ``ip a``
     - More methods at `opensource.com <https://opensource.com/article/18/5/how-find-ip-address-linux>`_
      
   - On macOS:
   
     - 1st method: use ``ipconfig getifaddr en1`` for wireless, or ``ipconfig getifaddr en0`` for ethernet.
     - 2nd method: ``ifconfig -a``
   
Prep test
---------
1. Do a version scan of each of the open ports of a network (active scanning): ``-sV``

   .. code-block::
   
      nmap -sV 10.1.0.0/24
      
2. `netdiscover <https://www.kali.org/tools/netdiscover/>`_ is an active/passive address reconnaissance tool 
   that is based on ARP packets. It will 
   send ARP requests and sniff for replies (from `github.com/netdiscover-scanner/netdiscover 
   <https://github.com/netdiscover-scanner/netdiscover>`_). Hence, it will list the active hosts on the network.

3. Identify systems that are up and running on a network with a **ping sweep**: ``-sp`` or ``-sn``
   
   - With ``-sp``:
   
     .. code-block::

        nmap -sP 192.168.1.0/24
        
   - With ``-sn``:
   
     .. code-block::
     
        nmap -sn 192.168.1.0/24  
   
4. Enumerate the shares on a Windows server that has the IP address of 10.1.0.10: ``--script smb-enum-shares.nse``

   .. code-block::
   
      nmap --script smb-enum-shares.nse 10.1.0.10


   The Nmap script ``smb-enum-shares.nse`` is used to perform this kind of enumeration of the network.

5. Disable pings (i.e. ping sweep) before enumerating the ports (i.e. port scan): ``-Pn``

   .. code-block::

      nmap -sS 10.1.0.0/24 -Pn

   `:information_source:` now a port scan is performed on every IP (even if the system is not running)

6. Perform the most accurate port scan possible: ``-st``

   .. code-block::
   
      nmap -sT 10.1.0.0/24
 
   `:information_source:` a TCP connect scan (*aka* Full connect scan) is an accurate port scan because it conducts a full three-way handshake.
 
7. Identify all systems with Remote Desktop Services (RDP) running: ``-p 3389``

   .. code-block::
   
      nmap -sS 10.1.0.0/24 -p 3389

   `:information_source:` Check `List of TCP and UDP port numbers (Wikipedia) <https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers>`_
   
      Port 3389: Microsoft Terminal Server (RDP) officially registered as Windows Based Terminal (WBT)

8. Identify the OS (OS fingerprinting) that is being used by the system with the IP address of 10.1.0.10: ``-O``

   .. code-block::

      nmap -sS -O 192.168.1.0/24
   
9. Perform a ping request in order to bypass a firewall that is blocking ICMP traffic: ``hping3``

   .. code-block::
   
      hping3 -c 3 -p 53 -S 10.1.0.10
      
   `:information_source:` 
   
    - Three packets are sent (``-c``)
    - 53 (``-p``) is the destination port that will receive these packets
    - The SYN flag is set in the packet (``-S``)
    - ``10.1.0.10`` is the system that is being pinged with TCP

10. Use ``Whois`` to identify email and IP addresses when performing a black box pentest.

11. Shodan (shodan.io) and ``maltego`` are OSINT (**passive**) information-gathering tools.
