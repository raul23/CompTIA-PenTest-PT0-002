====================================
Lab Exercises: Information gathering
====================================

.. contents:: **Contents**
   :depth: 5
   :local:
   :backlinks: top

Book: CompTIA Pentest+ Certification For Dummies (2nd ed., 2022)
================================================================
Exercise 3-1: Conduct a Whois Search with ARIN
----------------------------------------------
`:information_source:` using **www.arin.net/whois** to get information about an organization

1. Search for an organization
2. Click on the link for the Handle **"MICRO-218"**
3. At the bottom of the results, the entry **"Net Range"** gives the **public IPs** for the organization

   These are the public IP blocks that need to be documented in the pentest report.

Exercise 3-2: Use ``theHarvester`` to collect email addresses
-------------------------------------------------------------
`:information_source:` using ``theHarvester`` to collect email addresses and hosts IP addresses for an organization

On a terminal:

.. code-block::
   
   $ theharvester -d example.com -b all

The email and IP address need to be documented in the pentest report.

Exercise 3-3: Use Shodan to discover systems on the Internet
------------------------------------------------------------
`:information_source:` 
 
 - Using **shodan.io** to discover systems and information about systems on the Internet for an organization
 - You need to register to use **shodan.io**
 - The "View on Map" tab is only available if you become a member 
 - Search performed on 2023-02-16

1. Search for an organization
2. When clicking on an IP address, you can get lots of info about the organization such as:

   - Country, City, Organization, ISP, ASN
   - Vulnerabilities (list of CVEs), e.g.::
   
      CVE-2021-31806	An issue was discovered in Squid before 4.15 and 5.x before 5.0.6. Due to a 
                        memory-management bug, it is vulnerable to a Denial of Service attack (against 
                        all clients using the proxy) via HTTP Range request processing.
   - Certificates: name of server that issued them and their paths
   - Open Ports
   - The output from the server when connecting to an open port, e.g.::
  
      HTTP/1.1 400 Bad Request
      Server: squid/4.14
      Mime-Version: 1.0
      Date: Thu, 16 Feb 2023 19:07:45 GMT
      Content-Type: text/html;charset=utf-8
      Content-Length: 16
      X-Squid-Error: ERR_INVALID_URL 0

     `:information_source:` **Squid** is a caching and forwarding HTTP web proxy (from 
     `en.wikipedia.org/wiki/Squid_(software) <https://en.wikipedia.org/wiki/Squid_(software)>`_).

Exercise 3-4: Use ``recon-ng`` for OSINT information gathering
--------------------------------------------------------------
`:information_source:` 

 - Using ``recon-ng`` to perform OSINT information gathering
 - I used ``recon-ng`` v5.1.2 (the book uses an older version which uses a different syntax for a lot of the commands such 
   as ``workspaces add acme`` or ``add domains acme.com``)
 - Check the tutorial `101labs.net <https://www.101labs.net/comptia-security/lab-3-recon-ng/>`_ which uses ``recon-ng`` v5.1.1
 - Search performed on 2023-02-16

1. Start ``recon-ng`` and create a workspace:
 
   .. code-block::
   
      $ recon-ng
      
      [recon-ng][default] > workspaces create acme
      [recon-ng][acme] > 
  
2. Configure the domains and the company names:

   .. code-block::
   
      [recon-ng][acme] > db insert domains
      domain (TEXT): acme.com
      notes (TEXT): 
      
      [recon-ng][acme] > db insert companies
      company (TEXT): Acme~A publishing company
      description (TEXT):
      notes (TEXT): 

3. To view the domains and company tables:

   .. code-block::
   
        [recon-ng][acme] > show domains

        +----------------------------------------------+
        | rowid |     domain    | notes |    module    |
        +----------------------------------------------+
        | 1     | acme.com      |       | user_defined |
        +----------------------------------------------+
        
        [recon-ng][acme] > show companies

        +-------------------------------------------------------------------------+
        | rowid |          company           | description | notes |    module    |
        +-------------------------------------------------------------------------+
        | 1     | Acme~A publishing company  |             |       | user_defined |
        +-------------------------------------------------------------------------+

4. Install the WHOIS search module ``recon/domains-contacts/whois_pocs``:

   .. code-block::
   
      [recon-ng][acme] > marketplace search whois
      [*] Searching module index for 'whois'...                                                                                            
                                                                                                                                     
        +----------------------------------------------------------------------------------------------+                                   
        |                      Path                     | Version |     Status    |  Updated   | D | K |                                   
        +----------------------------------------------------------------------------------------------+                                   
        | recon/companies-domains/viewdns_reverse_whois | 1.1     | not installed | 2021-08-24 |   |   |
        | recon/companies-multi/whois_miner             | 1.1     | not installed | 2019-10-15 |   |   |
        | recon/domains-companies/whoxy_whois           | 1.1     | not installed | 2020-06-24 |   | * |
        | recon/domains-contacts/whois_pocs             | 1.0     | not installed | 2019-06-24 |   |   |
        | recon/netblocks-companies/whois_orgs          | 1.0     | not installed | 2019-06-24 |   |   |
        +----------------------------------------------------------------------------------------------+

        D = Has dependencies. See info for details.
        K = Requires keys. See info for details.

      [recon-ng][acme] > marketplace install recon/domains-contacts/whois_pocs
      [*] Module installed: recon/domains-contacts/whois_pocs
      [*] Reloading modules...

5. Load the module ``recon/domains-contacts/whois_pocs``:

   .. code-block::
   
      [recon-ng][acme] > modules load recon/domains-contacts/whois_pocs
      [recon-ng][acme][whois_pocs] >

6. To see information about the module ``recon/domains-contacts/whois_pocs``:

   .. code-block::
   
      [recon-ng][acme][whois_pocs] > info

            Name: Whois POC Harvester
          Author: Tim Tomes (@lanmaster53)
         Version: 1.0

      Description:
        Uses the ARIN Whois RWS to harvest POC data from whois queries for the given domain. Updates the
        'contacts' table with the results.

      Options:
        Name    Current Value  Required  Description
        ------  -------------  --------  -----------
        SOURCE  default        yes       source of input (see 'info' for details)

      Source Options:
        default        SELECT DISTINCT domain FROM domains WHERE domain IS NOT NULL
        <string>       string representing a single input
        <path>         path to a file containing a list of inputs
        query <sql>    database query returning one column of inputs

7. Begin searching WHOIS for information regarding “acme.com”:

   .. code-block::
   
      [recon-ng][acme][whois_pocs] > run

      ---------
      ACME.COM
      ---------
      [*] URL: http://whois.arin.net/rest/pocs;domain=acme.com
      [*] URL: http://whois.arin.net/rest/poc/EMBLE-ARIN
      [*] Country: United States
      [*] Email: blabla@acme.com
      [*] First_Name: Bla
      [*] Last_Name: Blabla
      [*] Middle_Name: None
      [*] Notes: None
      [*] Phone: None
      [*] Region: Toronto, ON
      [*] Title: Whois contact
      [*] --------------------------------------------------

8. Quit out of the ``whois_pocs`` module with the ``back`` command:

   .. code-block::
   
      [recon-ng][acme][whois_pocs] > back
      [recon-ng][acme] >

9. Install the Google and Bing search modules (``recon/domains-hosts/google_site_web`` and ``recon/domains-hosts/bing_domain_web``):

   .. code-block::
   
      [recon-ng][acme] > marketplace search google
      [*] Searching module index for 'google'...

        +------------------------------------------------------------------------------------+
        |                 Path                | Version |     Status    |  Updated   | D | K |
        +------------------------------------------------------------------------------------+
        | recon/domains-hosts/google_site_web | 1.0     | not installed | 2019-06-24 |   |   |
        +------------------------------------------------------------------------------------+

        D = Has dependencies. See info for details.
        K = Requires keys. See info for details.
        
      [recon-ng][acme] > marketplace install recon/domains-hosts/google_site_web
      [*] Module installed: recon/domains-hosts/google_site_web
      [*] Reloading modules...

      [recon-ng][acme] > marketplace search bing
      [*] Searching module index for 'bing'...

        +-----------------------------------------------------------------------------------------------+
        |                      Path                      | Version |     Status    |  Updated   | D | K |
        +-----------------------------------------------------------------------------------------------+
        | recon/companies-contacts/bing_linkedin_cache   | 1.0     | not installed | 2019-06-24 |   | * |
        | recon/domains-hosts/bing_domain_api            | 1.0     | not installed | 2019-06-24 |   | * |
        | recon/domains-hosts/bing_domain_web            | 1.1     | not installed | 2019-07-04 |   |   |
        | recon/hosts-hosts/bing_ip                      | 1.0     | not installed | 2019-06-24 |   | * |
        | recon/profiles-contacts/bing_linkedin_contacts | 1.2     | not installed | 2021-08-24 |   | * |
        +-----------------------------------------------------------------------------------------------+

        D = Has dependencies. See info for details.
        K = Requires keys. See info for details.

      [recon-ng][acme] > marketplace install recon/domains-hosts/bing_domain_web
      [*] Module installed: recon/domains-hosts/bing_domain_web
      [*] Reloading modules...

10. Load the module ``recon/domains-hosts/google_site_web``:

    .. code-block::
   
       [recon-ng][acme] > modules load recon/domains-hosts/google_site_web
       [recon-ng][acme][google_site_web] >

11. Retrieve a list of related domains and hosts from Google:

    .. code-block::
   
         [recon-ng][acme][google_site_web] > run
      
         ---------
         ACME.COM
         ---------
         [*] Searching Google for: site:acme.com
         [*] Country: None
         [*] Host: analyticals.online.acme.com
         [*] Ip_Address: None
         [*] Latitude: None
         [*] Longitude: None
         [*] Notes: None
         [*] Region: None
         [*] --------------------------------------------------

         [...]

         -------------
         WWW.ACME.COM
         -------------
         [*] Searching Google for: site:www.acme.com
         [!] Google CAPTCHA triggered. No bypass available.

         [...]

         -------
         SUMMARY
         -------
         [*] 41 total (41 new) hosts found.

    `:warning:` ``[!] Google CAPTCHA triggered. No bypass available.``
    
    `:information_source:` an attacker can target the various subdomains and IP addresses associated with acme.com 
    as they may not all be equally secure (from `101labs.net/comptia-security/lab-3-recon-ng 
    <https://www.101labs.net/comptia-security/lab-3-recon-ng/>`_)

12. Quit out from the Google search module and repeat steps 10 and 11 but with the Bing search module

    `:information_source:` 
    
     - The Bing search module sleeps to avoid lockout
    
       .. code-block::

          [*] Sleeping to avoid lockout...
          
     - There is no triggered CAPTCHA-like messages as it is the case with the Google search module

13. Install and load the module ``reporting/html``:

    .. code-block::
    
         [recon-ng][acme] > marketplace search reporting                                                                                             
         [*] Searching module index for 'reporting'...                                                                                                 

           +--------------------------------------------------------------------+
           |         Path        | Version |     Status    |  Updated   | D | K |
           +--------------------------------------------------------------------+
           | reporting/csv       | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/html      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/json      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/list      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/proxifier | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/pushpin   | 1.0     | not installed | 2019-06-24 |   | * |
           | reporting/xlsx      | 1.0     | not installed | 2019-06-24 |   |   |
           | reporting/xml       | 1.1     | not installed | 2019-06-24 |   |   |
           +--------------------------------------------------------------------+

           D = Has dependencies. See info for details.
           K = Requires keys. See info for details.

         [recon-ng][acme] > marketplace install reporting/html
         [*] Module installed: reporting/html
         [*] Reloading modules...
         
         [recon-ng][acme] > modules load reporting/html
         [recon-ng][acme][html] > info

            Name: HTML Report Generator
          Author: Tim Tomes (@lanmaster53)
         Version: 1.0

         Description:
           Creates an HTML report.

         Options:
           Name      Current Value                                       Required  Description
           --------  -------------                                       --------  -----------
           CREATOR                                                       yes       use creator name in the report footer
           CUSTOMER                                                      yes       use customer name in the report header
           FILENAME  /home/kali/.recon-ng/workspaces/acme/results.html   yes       path and filename for report output
           SANITIZE  True                                                yes       mask sensitive data in the report

14. Generate an HTML report:

    .. code-block::
   
         [recon-ng][acme][html] > options set CREATOR 'John Doe'
         CREATOR => 'John Doe'
         [recon-ng][acme][html] > options set CUSTOMER 'Jack Adams'
         CUSTOMER => 'Jack Adams'
         [recon-ng][acme][html] > run

Exercise 3-5: Use ``dig`` for DNS profiling
-------------------------------------------
`:information_source:` using ``dig`` to perform DNS profiling of an organization

1. Get the IP address of a system:

   .. code-block::
   
      dig www.domain_name.com +short
      
2. Get the DNS servers for the company:
 
   .. code-block::
   
      dig domain_name.com NS +short
      
4. Get the email servers for the company:

   .. code-block::
   
      dig domain_name.com MX +short
      
Exercise 3-6: Use ``nmap`` to port scan
---------------------------------------
`:information_source:` 

 - using ``nmap`` to perform a port scan of your network
 - I used ``nmap`` v7.93
 - Scan performed on 2023-02-16

1. Perform a SYN scan of your network (router):

   .. code-block::
   
      $ sudo nmap -sS 192.168.1.0
      Password:
      Starting Nmap 7.92 ( https://nmap.org ) at 2023-02-16 20:34 EST
      Nmap scan report for 192.168.1.0
      Host is up (0.015s latency).
      Not shown: 968 closed tcp ports (reset), 28 filtered tcp ports (no-response)
      PORT      STATE SERVICE
      80/tcp    open  http
      
   `:information_source:` If I don't use ``sudo``
   
   .. code-block::
   
      $ nmap -sS 192.168.1.0 
      You requested a scan type which requires root privileges.
      QUITTING!

2. Do a version scan:
3. Identify the OS that is running on the system:
